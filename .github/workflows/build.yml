name: Build

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

env:
  APP_NAME: upgo-node
  NODE_VERSION: "20"
  GO_VERSION: "1.24"

jobs:
  # ── Build per-platform (GUI + CLI in one binary) ─────────
  build:
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Windows ──────────────────────────────────────
          - os: windows-latest
            platform: windows/amd64
            artifact-name: upgo-node-windows-amd64
            libs: "windows-x64"
          - os: windows-latest
            platform: windows/386
            artifact-name: upgo-node-windows-x86
            libs: "windows-x86"
          # ── macOS (universal = Intel + Apple Silicon) ────
          - os: macos-latest
            platform: darwin/universal
            artifact-name: upgo-node-macos-universal
            libs: "darwin-arm64 darwin-amd64"
          # ── Linux ────────────────────────────────────────
          - os: ubuntu-22.04
            platform: linux/amd64
            artifact-name: upgo-node-linux-amd64
            libs: "linux-x64"
          - os: ubuntu-22.04
            platform: linux/arm64
            artifact-name: upgo-node-linux-arm64
            libs: "linux-arm64"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      # ── Linux amd64 native deps ──
      - name: Install Linux dependencies (amd64)
        if: matrix.platform == 'linux/amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev pkg-config

      # ── Linux arm64 cross-compile deps ──
      - name: Install Linux dependencies (arm64 cross)
        if: matrix.platform == 'linux/arm64'
        run: |
          sudo dpkg --add-architecture arm64
          # Add arm64 package sources
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libgtk-3-dev:arm64 libwebkit2gtk-4.0-dev:arm64 pkg-config

      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: Download native libraries for embedding
        run: bash scripts/download-libs.sh ${{ matrix.libs }}

      - name: Build
        run: |
          VERSION=${GITHUB_REF_NAME:-dev}

          # Set cross-compile env for Linux arm64
          if [[ "${{ matrix.platform }}" == "linux/arm64" ]]; then
            export CC=aarch64-linux-gnu-gcc
            export CXX=aarch64-linux-gnu-g++
            export CGO_ENABLED=1
            export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          fi

          wails build -platform ${{ matrix.platform }} \
            -ldflags "-s -w -X main.version=$VERSION"

      # ── Package: zip (Windows/macOS) or tar.gz (Linux) ──
      - name: Package artifact
        run: |
          cd build/bin
          NAME="${{ matrix.artifact-name }}"
          if [[ "${{ matrix.platform }}" == windows/* ]]; then
            7z a "../../${NAME}.zip" upgo-node.exe
          elif [[ "${{ matrix.platform }}" == darwin/* ]]; then
            zip -r "../../${NAME}.zip" upgo-node.app
          else
            chmod +x upgo-node
            tar czf "../../${NAME}.tar.gz" upgo-node
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            ${{ matrix.artifact-name }}.zip
            ${{ matrix.artifact-name }}.tar.gz

  # ── Release (on tag push) ───────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect release files
        run: |
          mkdir -p release
          find artifacts/ -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release/*
